# AvaTar

MLM на блокчейне. Ближайший пример: https://etherscan.io/address/0xA315bD2e3227C2ab71f1350644B01757EAFf9cb4#code

## Общая схема работы
### Новый пользователь
#### Схема через дефолтный платежный метод
1. У пользователя есть адрес реферала.
2. Пользователь отправляет 0.05 ETH на адрес контракта, указывая в `msg.data` адрес реферала.
#### Схема через API
1. Пользователь получает id реферала через метод `getNextUpliner()`, либо у пользователя уже есть id реферала.
2. Пользователь регистрируется в системе через метод `regUser()`, указывая в параметрах метода id реферала. Также при вызове `regUser()` пользоветель должен отправить 0.05 ETH.

### Существующий пользователь
- У зарегистрированного пользователя есть возможность купить следующий уровень через метод `buyLevel()`, указав в параметре метода желаемый уровень. 
- Пользователь также может купить очередной уровень, отправив сумму ETH, соответствующую желаемому уровню, на адрес контракта.
- Если пользователь покупает уровень на 1 меньше, чем его текущий, или на последнем 4м уровне заново покупает уровень 4, то такая операция считается "реинвестом". При реинвесте пользователь покупает уровень, который переносится в следующий цикл.

При вызове метода `buyLevel` также нужно отправить сумму в ETH, соответствующую желаемому уровню.

## API контракта

#### constructor(address payable _rootAddress)
- **_rootAddress** - root/master адрес самого 1го реферала. По умолчанию у root адреса есть все 4 уровня.

Конструктор контракта. Вызывается при миграции в сеть.

#### function() external payable
- **msg.data** - в случае регистрации нового юзера(не покупки очередного уровня) здесь нужно передать адрес реферала

Метод срабатывает в случае отправки эфира на адрес контракта. Автоматически регистрирует нового юзера(адрес реферала передается в `msg.data`) или покупает желаемый уровень(в зависимости от отправленной суммы ETH).

#### buyLevel(uint _level) external payable
- **_level** - уровень, который пользователь хочет купить

Метод покупки очередного уровня. При вызове метода пользователь также должен отправить сумму в ETH, соответствующую желаемому уровню.

#### getNextUpliner() external view returns (uint)
- **RETURN** - id реферала со свободными слотами

Метод возвращает id реферала со свободными слотами. Рефералы отсортированы по дате регистрации.

#### getUserCycleDetails(address _userAddress, uint _cycleIndex) external view returns(uint level, uint refsCount)
- **_userAddress** - адрес юзера
- **_cycleIndex** -  индекс цикла
- **RETURN** - уровень юзера и кол-во рефералов для выбранного цикла

Метод возвращает уровень пользователя и кол-во рефералов для заданного по индексу цикла.

#### regUser(uint _refId) external payable
- **_refId** - id реферала

Регистрирует нового пользователя в системе. При вызове метода юзер должен отправить сумму ETH, соответствующую уровню 1.

## Как запустить тесты
```
npm run test
```

## Как задеплоить контракт
1. В корне проекта создать файл `config.js` со следующими параметрами:
```
module.exports = {
	INFURA_KEY: "YOUR_INFURA_API KEY", // API KEY(project id) from infura.io
	MNEMONIC: "YOUR_MNEMONIC", // contract will be deployed from the 1st address of this mnemonic
	ROOT_ADDRESS: "0x1Bd5caB3445a9b0BD10c7E7a799d4164cF47D68b" // contract constructor param, address of the 1st node in the tree
};
```
2. `truffle migrate --network kovan`